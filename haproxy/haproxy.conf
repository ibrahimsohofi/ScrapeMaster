global
    daemon
    user haproxy
    group haproxy

    # SSL Configuration
    ssl-default-bind-ciphers ECDHE+aRSA+AESGCM:ECDHE+aRSA+SHA384:ECDHE+aRSA+SHA256:ECDHE+aRSA+RC4:DHE+aRSA+AESGCM:DHE+aRSA+SHA256:DHE+aRSA+SHA384:DHE+aRSA+RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11
    ssl-default-server-ciphers ECDHE+aRSA+AESGCM:ECDHE+aRSA+SHA384:ECDHE+aRSA+SHA256:ECDHE+aRSA+RC4:DHE+aRSA+AESGCM:DHE+aRSA+SHA256:DHE+aRSA+SHA384:DHE+aRSA+RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
    ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11

    # Logging
    log stdout local0 info

    # Performance tuning
    maxconn 4096
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 1024

    # Statistics
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option redispatch
    option forwardfor except 127.0.0.0/8
    option httpclose

    # Timeouts
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s

    # Health checks
    default-server init-addr last,libc,none

# Statistics and monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-node

    # Authentication for stats page
    stats auth admin:DataVault2024!

# Frontend for HTTPS traffic
frontend datavault_https
    bind *:443 ssl crt /etc/ssl/certs/datavault.pem

    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 20 }

    # API routing
    acl api_path path_beg /api
    acl websocket_upgrade hdr(Upgrade) -i websocket
    acl health_check path /health

    # Backend routing
    use_backend datavault_websocket if websocket_upgrade
    use_backend datavault_api if api_path
    use_backend datavault_health if health_check
    default_backend datavault_app

# Backend for main application
backend datavault_app
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost

    # Health check settings
    default-server check inter 10s fall 3 rise 2

    # Application servers
    server app1 datavault-app-1:3000 check weight 100 maxconn 500
    server app2 datavault-app-2:3000 check weight 100 maxconn 500
    server app3 datavault-app-3:3000 check weight 100 maxconn 500

# Backend for API requests
backend datavault_api
    balance leastconn
    option httpchk GET /api/health HTTP/1.1\r\nHost:\ localhost

    # Longer timeouts for API operations
    timeout server 120s
    timeout connect 10s

    # API servers
    server api1 datavault-app-1:3000 check weight 100 maxconn 200
    server api2 datavault-app-2:3000 check weight 100 maxconn 200
    server api3 datavault-app-3:3000 check weight 100 maxconn 200

# Backend for WebSocket connections
backend datavault_websocket
    balance source
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost

    # WebSocket specific settings
    timeout tunnel 3600s
    timeout server 3600s

    # WebSocket servers
    server ws1 datavault-app-1:3000 check weight 100
    server ws2 datavault-app-2:3000 check weight 100
    server ws3 datavault-app-3:3000 check weight 100

# Backend for health checks
backend datavault_health
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost

    # Quick health checks
    timeout server 5s
    timeout connect 2s

    # Health check servers
    server health1 datavault-app-1:3000 check inter 5s
    server health2 datavault-app-2:3000 check inter 5s
    server health3 datavault-app-3:3000 check inter 5s
